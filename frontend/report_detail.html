<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>報告詳情 - 漏洞報告管理系統</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="app-container">
        <!-- 側邊欄 -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <span class="logo-icon">🛡️</span>
                    <span class="logo-text">VulnTracker</span>
                </div>
            </div>
            <nav class="sidebar-nav">
                <a href="index.html" class="nav-item">
                    <span class="nav-icon">📊</span>
                    <span class="nav-text">儀表板</span>
                </a>
                <a href="reports.html" class="nav-item">
                    <span class="nav-icon">📋</span>
                    <span class="nav-text">報告列表</span>
                </a>
                <a href="logs.html" class="nav-item">
                    <span class="nav-icon">📜</span>
                    <span class="nav-text">操作日誌</span>
                </a>
                <div class="nav-divider"></div>
                <button class="nav-item" id="btn-import">
                    <span class="nav-icon">📥</span>
                    <span class="nav-text">匯入報告</span>
                </button>
                <a href="settings.html" class="nav-item">
                    <span class="nav-icon">⚙️</span>
                    <span class="nav-text">系統設定</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <div class="version">v1.0.0</div>
            </div>
        </aside>
        
        <!-- 主內容區 -->
        <main class="main-content">
            <div class="page-header">
                <a href="reports.html" class="btn btn-ghost">← 返回列表</a>
                <h1 id="report-title">載入中...</h1>
                <div class="page-actions">
                    <button class="btn btn-outline" onclick="exportReport()">📤 匯出 JSON</button>
                    <button class="btn btn-danger" onclick="deleteReport()">🗑️ 刪除報告</button>
                </div>
            </div>

            <!-- 報告資訊 -->
            <div class="report-info-grid">
                <div class="card info-card">
                    <div class="info-label">網站 URL</div>
                    <div class="info-value" id="info-site-url">-</div>
                </div>
                <div class="card info-card">
                    <div class="info-label">匯入時間</div>
                    <div class="info-value" id="info-imported-at">-</div>
                </div>
                <div class="card info-card">
                    <div class="info-label">Summary of Sequences</div>
                    <div class="info-value" id="info-summary">-</div>
                </div>
                <div class="card info-card">
                    <div class="info-label">Sequence Details</div>
                    <div class="info-value" id="info-details">-</div>
                </div>
            </div>

            <!-- 備註區 -->
            <div class="card">
                <div class="card-header">
                    <h3>📝 報告備註</h3>
                    <button class="btn btn-sm" onclick="saveNotes()">💾 儲存</button>
                </div>
                <div class="card-body">
                    <textarea id="report-notes" class="textarea" placeholder="輸入備註..."></textarea>
                </div>
            </div>

            <!-- 雙欄布局：檔案樹 + 漏洞詳情 -->
            <div class="detail-grid">
                <!-- 左側：漏洞樹 -->
                <div class="card tree-panel">
                    <div class="card-header">
                        <h3>📁 漏洞結構</h3>
                        <div class="tree-actions">
                            <button class="btn btn-xs" onclick="expandAll()">展開</button>
                            <button class="btn btn-xs" onclick="collapseAll()">收合</button>
                        </div>
                    </div>
                    <div class="card-body tree-body">
                        <div class="file-tree" id="vuln-tree">
                            <div class="loading">載入中...</div>
                        </div>
                    </div>
                </div>
                
                <!-- 右側：詳細資訊 -->
                <div class="card detail-panel">
                    <div class="card-header">
                        <h3>🔍 詳細資訊</h3>
                    </div>
                    <div class="card-body" id="detail-content">
                        <div class="empty-state">
                            <div class="empty-icon">👈</div>
                            <p>點擊左側項目查看詳情</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 漏洞表格 -->
            <div class="card">
                <div class="card-header">
                    <h3>📊 所有漏洞實例</h3>
                    <div class="batch-actions" id="batch-actions" style="display:none;">
                        <select id="batch-status" class="select select-sm">
                            <option value="">批次更新狀態</option>
                            <option value="fixed">✅ 已修復</option>
                            <option value="in_progress">🔄 處理中</option>
                            <option value="wont_fix">🚫 不修復</option>
                            <option value="false_positive">❌ 誤報</option>
                        </select>
                        <button class="btn btn-sm" onclick="batchUpdateStatus()">套用</button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th style="width:40px;"><input type="checkbox" id="select-all" onchange="toggleSelectAll()"></th>
                                <th style="width:80px;">嚴重等級</th>
                                <th>漏洞名稱</th>
                                <th>URL</th>
                                <th style="width:100px;">狀態</th>
                                <th style="width:80px;">操作</th>
                            </tr>
                        </thead>
                        <tbody id="instances-tbody">
                            <tr><td colspan="6" class="loading">載入中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 狀態更新 Modal -->
            <div class="modal" id="status-modal">
                <div class="modal-backdrop"></div>
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>更新狀態</h3>
                        <button class="modal-close" onclick="closeModal('status-modal')">&times;</button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="status-instance-id">
                        <div class="form-group">
                            <label>狀態</label>
                            <select id="status-select" class="select">
                                <option value="pending">⏳ 待處理</option>
                                <option value="in_progress">🔄 處理中</option>
                                <option value="fixed">✅ 已修復</option>
                                <option value="wont_fix">🚫 不修復</option>
                                <option value="false_positive">❌ 誤報</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>修復者</label>
                            <input type="text" id="status-fixed-by" class="input" placeholder="輸入修復者名稱">
                        </div>
                        <div class="form-group">
                            <label>備註</label>
                            <textarea id="status-notes" class="textarea" placeholder="輸入備註..."></textarea>
                        </div>
                        <div class="modal-actions">
                            <button class="btn btn-outline" onclick="closeModal('status-modal')">取消</button>
                            <button class="btn btn-primary" onclick="submitStatusUpdate()">確認</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 放大鏡 Modal -->
            <div class="zoom-modal" id="zoom-modal" onclick="closeZoomModal(event)">
                <div class="zoom-modal-backdrop"></div>
                <div class="zoom-modal-content" onclick="event.stopPropagation()">
                    <h4 id="zoom-title">詳細資訊</h4>
                    <p id="zoom-content"></p>
                </div>
            </div>
        </main>
    </div>
    
    <!-- 匯入 Modal -->
    <div class="modal" id="import-modal">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>📥 匯入 JSON 報告</h3>
                <button class="modal-close" onclick="closeModal('import-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="upload-zone" id="upload-zone">
                    <div class="upload-icon">📁</div>
                    <p>拖放 JSON 檔案到此處</p>
                    <p class="upload-hint">或點擊選擇檔案（支援多檔）</p>
                    <input type="file" id="file-input" accept=".json" multiple hidden>
                </div>
                <div class="upload-progress" id="upload-progress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <div class="progress-text" id="progress-text">上傳中...</div>
                </div>
                <div class="upload-results" id="upload-results"></div>
            </div>
        </div>
    </div>
    
    <!-- Toast 通知 -->
    <div class="toast-container" id="toast-container"></div>
    
    <script src="config.js"></script>
    <script src="js/common.js"></script>
    <script src="js/report_detail.js"></script>
</body>
</html>

